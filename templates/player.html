<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Nosso Player üíñ</title>
  <link rel="stylesheet" href="static/style.css">
  <script src="static/script.js"></script>
</head>
<body>
<div class="player-box">
  <div class="left-section">
    <img id="albumArt" class="album-art" src="" alt="Capa do √°lbum">
  </div>

  <div class="center-section">
    <div class="track-info">
      <div class="track-name-wrapper">
        <div id="trackName" class="track-name">Nome da m√∫sica</div>
        <a id="spotifyLink" href="#" target="_blank" class="spotify-btn" title="Ouvir no Spotify">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg" alt="Spotify" class="spotify-icon">
        </a>
      </div>
      <div id="artistName" class="artist-name">Artista</div>
    </div>
    <div class="progress-container">
      <span id="currentTime">0:00</span>
      <div class="progress" id="progressClickArea">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <span id="duration">0:00</span>
    </div>
  </div>

  <div class="right-section">
    <button id="playPauseBtn" onclick="togglePlayPause()">‚èµ</button>
    <button id="restartBtn" onclick="restartTrack()">‚Üª</button>
    <div class="volume-container">
      <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" orient="vertical">
    </div>
  </div>
</div>

<!-- Bot√£o "Iniciar Reprodu√ß√£o" removido -->

<div class="player-image">
    <div class="coracoes">
    <div class="um"></div>
    <div class="dois"></div>
    <div class="tres"></div>
    <div class="quatro"></div>
    <div class="cinco"></div>
</div>
</div>
<div class="pos-texto">
    <hr>
    <center><p class="texto_bonito">üíó Eu te amo h√°:</p></center>
    <p class="texto_contador"><span id="contador"></span></p>
    <hr>
    <p>
      Maria Eduarda, o seu sorriso √© a luz que ilumina todos os meus dias, cada momento ao seu lado √© √∫nico para mim, eu te amo muito mais do que qualquer palavra possa expressar. Voc√™ √© a raz√£o do meu sorriso, √© a dona do meu cora√ß√£o, "Por voc√™ eu dan√ßaria tango no teto, eu limparia os trilhos do metr√¥, eu iria a p√© do Rio a Salvador", eu faria tudo s√≥ para te ver feliz. Voc√™ √© a minha vida, o meu amor, um amor puro e verdadeiro, que n√£o tem fim, e como cantou Djavan: "O que h√° dentro do meu cora√ß√£o, eu tenho guardado pra te dar", "Um amor puro, quero mais que tudo, te amar sem limites", Maria Eduarda, voc√™ √© tudo para mim, e eu digo com toda a certeza do mundo que EU TE AMO e desejo passar o resto da minha vida ao seu lado, construindo mem√≥rias inesquec√≠veis, superando desafios e celebrando cada conquista juntos. Voc√™ √© a minha raz√£o de viver, e eu sou eternamente grato por ter voc√™ na minha vida, Eu te amo, te vivo. üíñ

      <p>"A gente n√£o precisa estar colado pra estar juntos, nossos corpos se conversam por horas e horas";</p>
      <p>"Eu n√£o preciso te olhar para te ter em meu mundo, porque aonde quer que eu v√° voc√™ est√° em tudo."</p>
      
  </p>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
const inicioAmor = new Date(2023, 4, 23, 0, 0, 0);
function atualizarContador() {
  const agora = new Date();
  let anos = agora.getFullYear() - inicioAmor.getFullYear();
  let meses = agora.getMonth() - inicioAmor.getMonth();
  let dias = agora.getDate() - inicioAmor.getDate();
  let horas = agora.getHours() - inicioAmor.getHours();
  let minutos = agora.getMinutes() - inicioAmor.getMinutes();
  let segundos = agora.getSeconds() - inicioAmor.getSeconds();

  if (segundos < 0) { segundos += 60; minutos--; }
  if (minutos < 0) { minutos += 60; horas--; }
  if (horas < 0) { horas += 24; dias--; }
  if (dias < 0) {
    const mesAnterior = new Date(agora.getFullYear(), agora.getMonth(), 0);
    dias += mesAnterior.getDate();
    meses--;
  }
  if (meses < 0) { meses += 12; anos--; }

  document.getElementById('contador').textContent =
    `${anos} anos, ${meses} meses, ${dias} dias, ${horas} horas, ${minutos} minutos e ${segundos} segundos`;
}
setInterval(atualizarContador, 1000);
atualizarContador();

const token = "{{ token }}";
let currentTrackURI = "spotify:track:0hJHknE2yxSNwC2jQTBuyq";
let durationMs = 0;
let currentProgress = 0;
let isPaused = true;
let lastUpdateTime = Date.now();

async function transferPlayback(device_id) {
  const res = await fetch('https://api.spotify.com/v1/me/player', {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_ids: [device_id],
      play: false
    })
  });

  if (!res.ok) {
    console.error("Erro ao transferir reprodu√ß√£o:", res.status, await res.text());
  }
}

window.onSpotifyWebPlaybackSDKReady = () => {
  const player = new Spotify.Player({
    name: 'Player Rom√¢ntico üíï',
    getOAuthToken: cb => { cb(token); },
    volume: 0.8
  });

  window.player = player;

  player.addListener('ready', async ({ device_id }) => {
    console.log('Player pronto. Device ID:', device_id);
    await transferPlayback(device_id);

    // Aqui dispara a reprodu√ß√£o autom√°tica ao iniciar o player
    restartTrack();
  });

  player.addListener('not_ready', ({ device_id }) => {
    console.log('Player desconectado:', device_id);
  });

  player.connect();

  document.getElementById('volumeControl').addEventListener('input', (e) => {
    const volume = parseFloat(e.target.value);
    player.setVolume(volume).catch(err => console.error("Erro ao ajustar volume:", err));
  });
};

function msToTime(ms) {
  const minutes = Math.floor(ms / 60000);
  const seconds = Math.floor((ms % 60000) / 1000);
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

document.getElementById('progressClickArea').addEventListener('click', async function (e) {
  const rect = this.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const width = rect.width;
  const percent = clickX / width;
  const newPositionMs = durationMs * percent;

  try {
    await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${Math.floor(newPositionMs)}`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    currentProgress = newPositionMs;
    lastUpdateTime = Date.now();
  } catch (error) {
    console.error('Erro ao pular para posi√ß√£o:', error);
  }
});

async function togglePlayPause() {
  const state = await player.getCurrentState();
  if (!state) {
    console.warn("Nenhum estado dispon√≠vel do player");
    return;
  }

  if (state.paused) {
    player.resume().then(() => {
      isPaused = false;
      lastUpdateTime = Date.now();
      updateTrackInfo();
      document.getElementById('playPauseBtn').innerHTML = '‚è∏';
    }).catch(err => console.error(err));
  } else {
    player.pause().then(() => {
      isPaused = true;
      document.getElementById('playPauseBtn').innerHTML = '‚èµ';
    }).catch(err => console.error(err));
  }
}

async function restartTrack() {
  try {
    await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=0`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    await fetch('https://api.spotify.com/v1/me/player/play', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uris: [currentTrackURI] })
    });

    isPaused = false;
    lastUpdateTime = Date.now();
    document.getElementById('playPauseBtn').innerHTML = '‚è∏';
    updateTrackInfo();
  } catch (error) {
    console.error("Erro ao reiniciar a m√∫sica:", error);
  }
}

async function updateTrackInfo() {
  try {
    const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.status === 204 || res.status > 400) return;

    const data = await res.json();
    if (!data || !data.item) return;

    const progress = data.progress_ms;
    durationMs = data.item.duration_ms;
    currentProgress = progress;
    isPaused = !data.is_playing;
    lastUpdateTime = Date.now();

    const percent = (progress / durationMs) * 100;

    document.getElementById('currentTime').innerText = msToTime(progress);
    document.getElementById('duration').innerText = msToTime(durationMs);
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('trackName').innerText = data.item.name;
    document.getElementById('artistName').innerText = data.item.artists.map(a => a.name).join(', ');
    document.getElementById('albumArt').src = data.item.album.images[0].url;
    document.getElementById('spotifyLink').href = data.item.external_urls.spotify;

  } catch (err) {
    console.error("Erro ao atualizar informa√ß√µes da faixa:", err);
  }
}

function updateProgressBarLoop() {
  setInterval(() => {
    if (!isPaused && durationMs > 0) {
      const now = Date.now();
      const elapsed = now - lastUpdateTime;
      currentProgress += elapsed;
      lastUpdateTime = now;

      if (currentProgress > durationMs) {
        currentProgress = durationMs;
      }

      const percent = (currentProgress / durationMs) * 100;
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('currentTime').innerText = msToTime(currentProgress);
    } else {
      lastUpdateTime = Date.now();
    }
  }, 1000);
}
updateProgressBarLoop();

const volumeSlider = document.getElementById('volumeControl');
function updateVolumeSliderColor() {
  const value = volumeSlider.value * 100;
  volumeSlider.style.background = `linear-gradient(to right, #f78ead 0%, #f78ead ${value}%, #ccc ${value}%, #ccc 100%)`;
}
volumeSlider.addEventListener('input', updateVolumeSliderColor);
updateVolumeSliderColor();
</script>
</body>
</html>
